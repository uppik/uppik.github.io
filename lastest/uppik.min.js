"use strict;";var Uppik=function(t,e){if(t instanceof HTMLElement||(t=document.getElementById(t)),this.target=t,this.options={showState:!0,onSuccess:this.onSuccess,onUpload:this.onUpload,onError:this.onError},e)for(key in e)this.options[key]=e[key];this.currentFile=null,this.tryTime=0,this.token="",this.endpoint="",this.quality=.5,this.fadeoutMessageInterval=null,this.hideMessageInterval=null,this.msgContainer=null,this.msgBody=null,this.currentFileIndex=1,this.totalFile=1,this.init()};Uppik.inquiryUrl="http://www.uppik.net/api/inquiry",Uppik.maxSize=1024,Uppik.messageTTL=5e3,Uppik.maxTry=10,Uppik.allowedMimes=["image/gif","image/jpeg","image/png","image/jpg"],Uppik.parseJson=function(t){var e={};try{e=JSON.parse(t)}catch(i){}return e},Uppik.prototype.init=function(){return this.initMessage(),this.checkRequirement()?(this.initElements(),void this.inquiry()):void this.disableUpload()},Uppik.prototype.initMessage=function(){var t=document.createElement("div");t.style.position="fixed",t.style.top=0,t.style.left=0,t.style.width="100%",t.style.display="none",t.style.textAlign="center",t.style.backgroundColor="transparent",t.style.transition="opacity 0.5s ease",this.msgContainer=t;var e=document.createElement("span");e.style.display="inline-block",e.style.padding="0.5em 1.5em",e.style.marginTop="0.5em",e.style.borderRadius="1em",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.msgBody=e,t.appendChild(e),document.body.appendChild(t)},Uppik.prototype.initElements=function(){this.target.style.position="relative",this.target.style.overflow="hidden";var t=document.createElement("input");t.type="file",t.style.width="1000px",t.style.height="1000px",t.style.fontSize="1000px",t.style.opacity=0,t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.cursor="pointer",this.input=t,this.target.appendChild(t);var e=this;t.onchange=function(t){t.stopPropagation(),e.onFileSelected(t)}},Uppik.prototype.disableUpload=function(){var t=this;this.target.onclick=function(e){e.preventDefault(),t.showMessage("This browser is not supported, lets switch to a modern browser.",!0)}},Uppik.prototype.showMessage=function(t,e,i){this.fadeoutMessageInterval&&(clearInterval(this.fadeoutMessageInterval),this.fadeoutMessageInterval=null),this.hideMessageInterval&&(clearInterval(this.hideMessageInterval),this.hideMessageInterval=null),this.msgBody.innerText=t,e?this.msgBody.style.color="#ff0000":this.msgBody.style.color="#00ff00",this.msgContainer.style.opacity=1,this.msgContainer.style.display="block";var s=this;i||(this.hideMessageInterval=setInterval(function(){s.hideMessage()},Uppik.messageTTL))},Uppik.prototype.hideMessage=function(){this.hideMessageInterval&&(clearInterval(this.hideMessageInterval),this.hideMessageInterval=null),this.msgContainer.style.opacity=0;var t=this;this.fadeoutMessageInterval=setInterval(function(){t.msgContainer.style.display="none",t.fadeoutMessageInterval&&(clearInterval(t.fadeoutMessageInterval),t.fadeoutMessageInterval=null)},500)},Uppik.prototype._onSuccess=function(t){this.input.value=null,this.input.removeAttribute("disabled"),this.options.onSuccess.apply(this,[t.url,t])},Uppik.prototype._onUpload=function(){this.input.disabled=!0,this.options.showState&&this.showMessage("Uploading...",!1,!0),this.options.onUpload.apply(this,[this.currentFileIndex,this.totalFile])},Uppik.prototype._onError=function(t){this.input.value=null,this.input.removeAttribute("disabled"),this.options.showState&&this.showMessage(t,!0),this.options.onError.apply(this,[t])},Uppik.prototype.onFileSelected=function(t){this.loadImage(t.target.files[0])},Uppik.prototype.onSuccess=function(t,e){console.log(e)},Uppik.prototype.onUpload=function(t,e){console.log("Uploading...")},Uppik.prototype.onError=function(t){console.log(t)},Uppik.prototype.inquiry=function(){var t=new XMLHttpRequest,e=this;"withCredentials"in t&&(t.open("GET",Uppik.inquiryUrl,!0),t.onreadystatechange=function(){if(4===t.readyState){if(t.status>=200&&t.status<400){var i=Uppik.parseJson(t.responseText);if(i.endpoint)return e.endpoint=i.endpoint,e.token=i.token,void(e.quality=i.quality)}e.showMessage("Cannot get information from server. Please try later.",!0)}},t.send())},Uppik.prototype.upload=function(t){if(""!=this.token&&""!=this.enpoint){var e=new XMLHttpRequest,i=this;"withCredentials"in e&&(e.open("POST",this.endpoint+"/upload",!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){if(4===e.readyState){if(e.status>=200&&e.status<400){var t=Uppik.parseJson(e.responseText);if(t.image)return void i._onSuccess(t.image);if(t.id)return i.tryTime=0,i.currentFile=t.id,void i.delayQueryStatus()}i._onError("Upload failed, please try again later.")}},this.hideMessage(),e.send("token="+this.token+"&data="+encodeURI(t)),this._onUpload())}},Uppik.prototype.checkRequirement=function(){return"undefined"==typeof window.URL?!1:!0},Uppik.prototype.queryStatus=function(){if(""!=this.token&&""!=this.endpoint){var t=new XMLHttpRequest,e=this;"withCredentials"in t&&(t.open("GET",this.endpoint+"/status?id="+this.currentFile+"&token="+this.token,!0),t.onreadystatechange=function(){if(4===t.readyState){if(t.status>=200&&t.status<400){var i=Uppik.parseJson(t.responseText);if("success"==i.status)return void e._onSuccess(i.image);if("failed"==i.status)return void e.showMessage(i.error,!0)}e.tryTime++,e.tryTime<Uppik.maxTry?e.delayQueryStatus():e._onError("Upload timeout, please try again.")}},t.send())}},Uppik.prototype.delayQueryStatus=function(){var t=this;setTimeout(function(){t.queryStatus()},1e3)},Uppik.prototype.loadImage=function(t){var e=URL.createObjectURL(t),i=new Image,s=this;-1!=Uppik.allowedMimes.indexOf(t.type)&&(i.onload=function(){URL.revokeObjectURL(e);var t=i.width,n=i.height,o=t,a=n;t>n?t>Uppik.maxSize&&(o=Uppik.maxSize,a=Uppik.maxSize*n/t):n>Uppik.maxSize&&(o=Uppik.maxSize*t/n,a=Uppik.maxSize);var p=s.getCanvas();p.width=o,p.height=a,p.getContext("2d").drawImage(i,0,0,o,a);var r=p.toDataURL("image/jpeg",s.quality),l=r.replace(/^data:image\/jpeg;base64,/,"");s.upload(l)},i.src=e)},Uppik.prototype.getCanvas=function(){return this.canvas||(this.canvas=document.createElement("canvas")),this.canvas};